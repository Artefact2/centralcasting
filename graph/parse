#!/usr/bin/env php
<?php

function getcolor(string $s): string {
	if($s !== '' && ctype_digit($s[0])) {
		$i = (int)$s[0];
		if($i > 0 && $i < 9) {
			return '/set39/'.$s[0];
		}
	}
	return '/set39/9';
}

echo "digraph {\n";
echo "rankdir=\"LR\"\n";
echo "overlap=false\n";
echo "splines=true\n";

$datas = [];

foreach(glob(__DIR__.'/../data/*.php') as $path) {
	$datas[pathinfo($path, PATHINFO_FILENAME)] = $path;
}

foreach($datas as $name => $path) {
	$source = file_get_contents($path);
	
	preg_match('%Table\([^,]+,\s*("'.$name.'"|\''.$name.'\')\s*,\s*(("[^"]*")|(\'[^\']*\'))\s*,%U', $source, $match);
	$displayname = $name;
	if(isset($match[2])) {
		$displayname .= "\n".substr($match[2], 1, -1);
	} else {
		preg_match('%/\*<<< Name: (.+) >>>\*/%U', $source, $match);
		if(isset($match[1])) {
			$displayname .= "\n".$match[1];
		} else {
			fprintf(STDERR, "NOTICE: data %s has no name\n", $name);
		}
	}

	if(preg_match('%^[0-9]%', $name)) {
		if(preg_match('%[A-Z]$%', $name)) {
			$shape = 'note';
		} else {
			$shape = isset($datas[$name.'A']) ? 'folder' : 'box';
		}
	} else {
		$shape = 'doublecircle';
	}
	
	printf("\"%s\" [style=filled fillcolor=\"%s\" label=\"%s\" shape=%s]\n", $name, getcolor($name), $displayname, $shape);

	preg_match_all('%Invoker?\(([^)]+)\)%U', $source, $matches);
	foreach($matches[1] as $m) {
		preg_match_all('%"([^"]+)"%U', $m, $submatches);
		foreach($submatches[1] as $sm) {
			printf("\"%s\" -> \"%s\"\n", $name, $sm);
		}
	}
}

echo "}\n";
